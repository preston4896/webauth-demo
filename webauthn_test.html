<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Test</title>
</head>
<body>
    <h1>WebAuthn Test Page</h1>
    <button onclick="createCredential()">Create Credential</button>
    <button onclick="getSignature()">Get Signature</button>

    <script src="./cbor.js"></script>
    
    <script>
        function buf2hex(buffer) { // buffer is an ArrayBuffer  
            return [...new Uint8Array(buffer)] .map(x => x.toString(16).padStart(2, '0'))
                .join('');
        }

        function derToBytes(signature) {
            var usignature = new Uint8Array(signature);
            var rStart = usignature[4] === 0 ? 5 : 4;
            var rEnd = rStart + 32;
            var sStart = usignature[rEnd + 2] === 0 ? rEnd + 3 : rEnd + 2;
            var r = usignature.slice(rStart, rEnd);
            var s = usignature.slice(sStart);
            return new Uint8Array([...r, ...s]);
        }

        async function createCredential() {
            const publicKey = {
                challenge: new Uint8Array([1]),
                rp: {
                    name: "Your WebAuthn Demo"
                },
                user: {
                    id: new Uint8Array([1]),
                    name: "username",
                    displayName: "User Name"
                },
                pubKeyCredParams: [
                    {
                        type: "public-key",
                        alg: -7  // "ES256" IANA COSE Algorithms registry
                    }
                ],
                attestation: "direct",
                authenticatorSelection: {
                    userVerification: "preferred",
                    residentKey: "discouraged",
                }
            };

            try {
                const credential = await navigator.credentials.create({ publicKey });
                console.log('Credential created:', credential);
                // console.log('client data hex: ', credential.response.clientDataJSON);
                console.log('client data hex: ', buf2hex(credential.response.clientDataJSON));
                const attestationObject = credential.response.attestationObject;
                console.log('attestationObject: ', attestationObject);
                const decodedAttestationObject = CBOR.decode(attestationObject);
                console.log('authData: ', decodedAttestationObject.authData);
                const authDataHex = buf2hex(decodedAttestationObject.authData);
                console.log(decodedAttestationObject.authData)
                // const authDataHex = "0x" + decodedAttestationObject.authData.toString("hex");
                console.log('authDataHex: ', authDataHex);
                
                const authData = decodedAttestationObject.authData;
                const cred = authData.slice(55, 55+32);
                await getSignature(cred);
                
            } catch (err) {
                console.error('Error creating credential:', err);
            }
        }

        async function getSignature(id) {
            const publicKey = {
                challenge: new Uint8Array([48, 120, 49, 52, 53, 100, 99, 50, 101, 48, 101, 49, 98, 50, 99, 99, 48, 56, 101, 101, 52, 97, 50, 99, 102, 97, 100, 52, 102, 49, 57, 50, 51, 49, 55, 53, 48, 100, 102, 54, 98, 51, 55, 52, 98, 48, 50, 99, 102, 100, 101, 102, 57, 102, 50, 53, 98, 101, 97, 53, 101, 99, 50, 52, 50, 54]),
                allowCredentials: [{
                    type: "public-key",
                    id: id
                    // id: new Uint8Array([202, 71, 207, 238, 32, 65, 85, 196, 220, 193, 45, 139, 76, 246, 100, 60, 169, 189, 83, 36, 65, 150, 63, 177, 173, 147, 54, 164, 73, 99, 111, 155])
                }]
            };

            try {
                const assertion = await navigator.credentials.get({ publicKey });
                console.log('Assertion:', assertion);
                // console.log('client data hex: ', credential.response.clientDataJSON);
                console.log('credId: ', buf2hex(id));
                console.log('client data hex: ', buf2hex(assertion.response.clientDataJSON));
                console.log('authData: ', assertion.response.authenticatorData);
                const authDataHex = buf2hex(assertion.response.authenticatorData);
                // const authDataHex = "0x" + decodedAttestationObject.authData.toString("hex");
                console.log('authDataHex: ', authDataHex);
                console.log('sig: ', buf2hex(derToBytes(assertion.response.signature)));
            } catch (err) {
                console.error('Error getting signature:', err);
            }
        }

        
    </script>
</body>
</html>

